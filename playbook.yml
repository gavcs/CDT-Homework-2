---
- name: Setup IRC Server with Intentional Vulnerabilities
  hosts: ircserver
  become: true
  vars:
    irc_server_dir: /opt/ircd
    irc_log_dir: /var/log/ircd
    flag: "FLAG{1RC_L0GS_4R3_N0T_S3CUR3_8y_D3F4ULT}"
    irc_password: "cyberpsychosis"

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - inspircd
          - python3-pip
        state: present

    - name: Create IRC server directory
      ansible.builtin.file:
        path: "{{ irc_server_dir }}"
        state: directory
        mode: '0755'
        owner: irc
        group: irc

    - name: Create IRC log directory with weak permissions (VULNERABILITY 1)
      ansible.builtin.file:
        path: "{{ irc_log_dir }}"
        state: directory
        mode: '0755'
        owner: irc
        group: irc

    - name: Configure InspIRCd with logging enabled
      ansible.builtin.copy:
        src: resources/config.conf
        dest: /etc/inspircd/inspircd.conf
        mode: '0644'

    - name: Create MOTD file
      ansible.builtin.copy:
        dest: /etc/inspircd/motd.txt
        mode: '0644'
        content: |
          ========================================
          Welcome to CTF IRC Server
          ========================================
          This is a training environment.
          Have fun and hack responsibly!
          ========================================

    - name: Create rules file
      ansible.builtin.copy:
        dest: /etc/inspircd/rules.txt
        mode: '0644'
        content: |
          1. Be respectful
          2. No flooding
          3. Follow CTF rules

    - name: Create IRC logging bot
      ansible.builtin.copy:
        dest: /usr/local/bin/irc-logger.py
        mode: '0755'
        content: |
          #!/usr/bin/env python3
          import socket
          import time
          from datetime import datetime

          SERVER = "127.0.0.1"
          PORT = 6667
          PASSWORD = "cyberpsychosis"
          NICKNAME = "logger"
          CHANNEL = "#general"
          LOGFILE = "/var/log/ircd/messages.log"

          def log_message(msg):
              timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
              with open(LOGFILE, 'a') as f:
                  f.write(f"{timestamp} {msg}\n")

          sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
          sock.connect((SERVER, PORT))

          sock.send(f"PASS {PASSWORD}\r\n".encode())
          sock.send(f"NICK {NICKNAME}\r\n".encode())
          sock.send(f"USER {NICKNAME} 0 * :Logger Bot\r\n".encode())

          time.sleep(2)
          sock.send(f"JOIN {CHANNEL}\r\n".encode())

          while True:
              try:
                  data = sock.recv(4096).decode('utf-8', errors='ignore')
                  if not data:
                      break

                  for line in data.split('\r\n'):
                      if line:
                          log_message(line)

                          # Handle PING
                          if line.startswith('PING'):
                              sock.send(f"PONG {line.split()[1]}\r\n".encode())

                          # Log channel messages
                          if 'PRIVMSG' in line and CHANNEL in line:
                              log_message(line)
              except:
                  break

          sock.close()

    - name: Create systemd service for IRC logger
      ansible.builtin.copy:
        dest: /etc/systemd/system/irc-logger.service
        mode: '0644'
        content: |
          [Unit]
          Description=IRC Message Logger
          After=inspircd.service
          Requires=inspircd.service

          [Service]
          Type=simple
          ExecStart=/usr/bin/python3 /usr/local/bin/irc-logger.py
          Restart=always
          User=irc

          [Install]
          WantedBy=multi-user.target

    - name: Start IRC logger service
      ansible.builtin.systemd:
        name: irc-logger
        enabled: true
        state: started
        daemon_reload: true

    # - name: Install git and build tools for custom module
    #   ansible.builtin.apt:
    #     name:
    #       - git
    #       - g++
    #       - make
    #       - pkg-config
    #       - inspircd-dev
    #     state: present

    # - name: Create m_chatlog module source
    #   ansible.builtin.copy:
    #     dest: /tmp/m_chatlog.cpp
    #     mode: '0644'
    #     content: |
    #       #include "inspircd.h"
    #       #include <fstream>

    #       class ModuleChatLog : public Module
    #       {
    #       private:
    #         std::string logfile;

    #       public:
    #         void ReadConfig(ConfigStatus& status) CXX11_OVERRIDE
    #         {
    #           ConfigTag* tag = ServerInstance->Config->ConfValue("chatlog");
    #           logfile = tag->getString("target", "/var/log/ircd/messages.log");
    #         }

    #         void OnUserPostMessage(User* user, const MessageTarget& target, const MessageDetails& details) CXX11_OVERRIDE
    #         {
    #           if (target.type == MessageTarget::TYPE_CHANNEL)
    #           {
    #             Channel* chan = target.Get<Channel>();
    #             time_t rawtime;
    #             struct tm* timeinfo;
    #             char buffer[80];

    #             time(&rawtime);
    #             timeinfo = localtime(&rawtime);
    #             strftime(buffer, sizeof(buffer), "%Y-%m-%d %H:%M:%S", timeinfo);

    #             std::ofstream log(logfile.c_str(), std::ios::app);
    #             if (log.is_open())
    #             {
    #               log << buffer << " " << chan->name << " <" << user->nick << "> " << details.text << std::endl;
    #               log.close();
    #             }
    #           }
    #         }

    #         Version GetVersion() CXX11_OVERRIDE
    #         {
    #           return Version("Logs channel messages to file", VF_VENDOR);
    #         }
    #       };

    #       MODULE_INIT(ModuleChatLog)

    # - name: Compile m_chatlog module
    #   ansible.builtin.shell: |
    #     g++ -shared -fPIC -DPIC -std=c++11 \
    #       -I/usr/include/inspircd \
    #       -o /usr/lib/inspircd/modules/m_chatlog.so \
    #       /tmp/m_chatlog.cpp
    #   args:
    #     executable: /bin/bash
    #     creates: /usr/lib/inspircd/modules/m_chatlog.so

    # - name: Set permissions on m_chatlog module
    #   ansible.builtin.file:
    #     path: /usr/lib/inspircd/modules/m_chatlog.so
    #     owner: root
    #     group: root
    #     mode: '0644'

    - name: Ensure InspIRCd service is enabled and started
      ansible.builtin.systemd:
        name: inspircd
        enabled: true
        state: restarted

    - name: Wait for IRC server to be ready
      ansible.builtin.wait_for:
        port: 6667
        delay: 5
        timeout: 30

    - name: Create backup script with weak permissions (VULNERABILITY 3)
      ansible.builtin.copy:
        src: resources/irc-backup.sh
        dest: /usr/local/bin/irc-backup.sh
        mode: '0755'

- name: Setup IRC Clients
  hosts: ircclients
  become: true
  vars:
    irc_server: "100.65.7.86"
    irc_password: "cyberpsychosis"
    flag: "FLAG{1RC_L0GS_4R3_N0T_S3CUR3_8y_D3F4ULT}"

  tasks:
    - name: Install IRC client and dependencies
      ansible.builtin.apt:
        name:
          - python3-pip
          - netcat-openbsd
        state: present
        update_cache: true

    - name: Create IRC client scripts directory
      ansible.builtin.file:
        path: /opt/irc-scripts
        state: directory
        mode: '0755'

    - name: Create python script for client 1 (flag holder)
      ansible.builtin.template:
        src: resources/send_flag.py
        dest: /opt/irc-scripts/send_flag.py
        mode: '0755'
      when: inventory_hostname == "gwm8432-client01"

    - name: Create python script for client 2
      ansible.builtin.template:
        src: resources/chat_normal.py
        dest: /opt/irc-scripts/chat_normal.py
        mode: '0755'
      when: inventory_hostname == "gwm8432-client02"


- name: Execute IRC Client Conversations
  hosts: ircclients
  become: true
  serial: 1  # Run one at a time to maintain message order

  tasks:
    - name: Wait for IRC server to be fully ready
      ansible.builtin.wait_for:
        host: "100.65.7.86"
        port: 6667
        delay: 5
        timeout: 60

    - name: Execute client 1 script (Alice with flag)
      ansible.builtin.command:
        cmd: /usr/bin/python3 /opt/irc-scripts/send_flag.py
      when: inventory_hostname == "gwm8432-client01"
      register: client1_output
      changed_when: true

    - name: Display client 1 client1_output
      ansible.builtin.debug:
        var: client1_output.stdout_lines
      when: inventory_hostname == "gwm8432-client01"

    - name: Wait between clients
      ansible.builtin.pause:
        seconds: 3
      when: inventory_hostname == "gwm8432-client01"

    - name: Execute client 2 script (Bob)
      ansible.builtin.command:
        cmd: /usr/bin/python3 /opt/irc-scripts/chat_normal.py
      when: inventory_hostname == "gwm8432-client02"
      register: client2_output
      changed_when: true

    - name: Display client 2 output
      ansible.builtin.debug:
        var: cleint2_output.stdout_lines
      when: inventory_hostname == "gwm8432-client02"


- name: Final Server Configuration
  hosts: ircserver
  become: true

  tasks:
    - name: Set permissive permissions on message log (VULNERABILITY 6)
      ansible.builtin.file:
        path: /var/log/ircd/messages.log
        mode: '0644'
        owner: irc
        group: irc
        state: touch  # Changed from "file" to "touch" - creates if doesn't exist

    - name: Create additional vulnerability - exposed config backup
      ansible.builtin.copy:
        src: /etc/inspircd/inspircd.conf
        dest: /tmp/inspircd.conf.bak
        mode: '0644'
        remote_src: true

    - name: Display completion message
      ansible.builtin.debug:
        msg:
          - "IRC CTF Environment Setup Complete!"
          - "IRC Server: 100.65.7.86:6667"
          - "Message logs: /var/log/ircd/messages.log"
          - "Vulnerabilities planted successfully!"
          - ""
          - "Exploitation Path:"
          - "1. Find IRC server (nmap)"
          - "2. Discover password requirement"
          - "3. Find password in backup script or config backup"
          - "4. Connect to IRC or read logs directly"
          - "5. Extract flag from messages.log"
